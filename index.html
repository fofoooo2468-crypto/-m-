
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>محلل المهام التنظيمية</title>
  <style>
    body { font-family: "Tahoma","Segoe UI",Arial,sans-serif; margin:24px; line-height:1.8; background:#fafafa; color:#222; }
    h2 { margin-top:0; }
    textarea { width:100%; max-width:900px; box-sizing:border-box; padding:12px; border:1px solid #ddd; border-radius:8px; background:#fff; font-size:15px; resize:vertical; }
    .actions { margin:12px 0 20px; display:flex; gap:10px; flex-wrap:wrap; }
    button { background:#0b5394; color:#fff; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-size:14px; }
    button.secondary { background:#777; }
    .result { max-width:900px; background:#fff; border:1px solid #eee; border-radius:10px; padding:16px; min-height:60px; white-space:pre-wrap; word-break:break-word; }
    .verb{color:#0b5394;font-weight:bold;} .domain{color:#38761d;font-weight:bold;} .tool{color:#7f6000;font-weight:bold;} .output{color:#990000;font-weight:bold;}
    .ok{color:green} .bad{color:#c00}
  </style>
</head>
<body>

  <h2>محلل صياغة المهام التنظيمية</h2>

  <label for="taskInput" style="display:block;margin-bottom:6px;">
    أدخل مهمة أو أكثر (كل مهمة في سطر مستقل):
  </label>
  <textarea id="taskInput" rows="6" placeholder="مثال:
متابعة أداء شركات العمرة
إشراف أعمال مزودي خدمات الحجاج"></textarea>

  <div class="actions">
    <!-- استدعاء مباشر بدون أي تعقيدات ربط -->
    <button type="button" onclick="analyzeTask()">تحليل المهام</button>
    <button class="secondary" type="button" onclick="clearAll()">مسح الإدخال</button>
    <button class="secondary" type="button" onclick="copyOut()">نسخ المخرجات</button>
  </div>

  <div class="result" id="output" aria-live="polite"></div>

  <!-- كل المنطق مضمَّن هنا -->
  <script>
    /* ========= أدوات مساعدة ========= */
    function norm(s){return (s||"").replace(/[إأآا]/g,"ا").replace(/ى/g,"ي").replace(/ة/g,"ه").replace(/[^\u0600-\u06FF0-9A-Za-z\s]/g,"").trim();}
    function escapeHTML(s){return (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");}

    // موصلات وألفاظ شائعة للأداة والمخرج
    const TOOL_CONNECTORS = ["من خلال","وفق","بموجب","استنادًا إلى","استنادا إلى","بالاعتماد على","استنادا الى","استنادًا الى"];
    const OUT_CONNECTORS  = ["بما ينتج عنه","بما يحقق","بهدف","لتحقيق","ليتم","لـ","لقياس","ما ينتج عنه"];

    // قوائم العناصر
    const VERBS   = ["مراقبة","متابعة","تفتيش","تقييم","إشراف","حوكمة","إدارة","تنظيم","اعتماد","تصنيف","ترخيص"];
    const TOOL_KW = ["معايير","سياسات","لوائح","ضوابط","أطر","أدلة","إجراءات","مرجعيات","معايير الامتثال","مؤشرات الأداء","أطر الحوكمة","التشريعات"];
    const OUT_KW  = ["تقرير","تقارير","قرار","مستوى","نتائج","توصيات","تصنيف","اعتماد","إطار","مؤشرات","قياس","رفع"];

    // فهرسة تقريبية من نص مطبَّع إلى نص أصلي
    function charIndexFromNorm(original,normIndex){
      let o=0,count=0;
      while(o<original.length && count<normIndex){
        const mapped=norm(original[o]);
        count += mapped.length ? 1 : 0; o++;
      }
      return o;
    }

    function extractPieces(raw){
      const txt=raw.trim(); const n=norm(txt);
      // 1) الفعل
      let verb="", vIdx=-1;
      for(const v of VERBS){const nv=norm(v); const i=n.indexOf(nv); if(i>-1 && (vIdx===-1 || i<vIdx)){vIdx=i; verb=v;}}
      // 2) موصلات الأداة/المخرج
      let tIdx=-1, tConn=null; for(const c of TOOL_CONNECTORS){const i=n.indexOf(norm(c)); if(i>-1 && (tIdx===-1||i<tIdx)){tIdx=i; tConn=c;}}
      let oIdx=-1, oConn=null; for(const c of OUT_CONNECTORS){const i=n.indexOf(norm(c)); if(i>-1 && (oIdx===-1||i<oIdx)){oIdx=i; oConn=c;}}
      // 3) المجال: بعد الفعل حتى أول موصل
      const startAfterVerb = vIdx>-1 ? vIdx + norm(verb).length : 0;
      const firstBreak = [tIdx,oIdx].filter(x=>x>-1).sort((a,b)=>a-b)[0] ?? n.length;
      let domain = txt.substring(charIndexFromNorm(txt,startAfterVerb), charIndexFromNorm(txt,firstBreak)).replace(/^[\s:،.-]+|[\s:،.-]+$/g,"");
      if(domain.split(/\s+/).filter(Boolean).length < 2){
        const words=txt.split(/\s+/).filter(Boolean);
        domain = words.slice(-4).join(" ");
      }
      // 4) الأداة
      let toolPhrase="";
      if(tIdx>-1){
        const end = (oIdx>-1 && oIdx>tIdx) ? oIdx : n.length;
        toolPhrase = txt.substring(charIndexFromNorm(txt,tIdx), charIndexFromNorm(txt,end)).trim();
      }
      // 5) المخرج
      let outPhrase="";
      if(oIdx>-1){ outPhrase = txt.substring(charIndexFromNorm(txt,oIdx)).trim(); }
      else if(OUT_KW.some(k=>n.includes(norm(k)))){
        outPhrase = "بإصدار تقرير وقياس مستوى الأداء وفق مؤشرات معتمدة";
      }
      return {verb,domain,toolPhrase:toolPhrase,outPhrase:outPhrase};
    }

    function hasTool(text){const n=norm(text||""); return TOOL_CONNECTORS.some(c=>n.includes(norm(c))) || TOOL_KW.some(k=>n.includes(norm(k)));}
    function hasOut(text){const n=norm(text||""); return OUT_CONNECTORS.some(c=>n.includes(norm(c))) || OUT_KW.some(k=>n.includes(norm(k)));}

    function buildSuggestions({verb,domain}){
      const v = verb || "مراقبة";
      const d = escapeHTML(domain || "المجال");
      const s1 = `${v} <span class="domain">${d}</span> من خلال <span class="tool">معايير الامتثال المعتمدة</span> لقياس <span class="output">مستوى الالتزام بها</span> وفق <span class="tool">مؤشرات معتمدة</span>.`;
      const s2 = `${v==="مراقبة"?"إشراف":"مراقبة"} <span class="domain">${d}</span> وفق <span class="tool">أطر الحوكمة والسياسات المعتمدة</span> بما يحقق <span class="output">ضبط الممارسات وإصدار تقارير دورية</span>.`;
      const s3 = `تنظيم <span class="domain">${d}</span> بموجب <span class="tool">لوائح وتعليمات معتمدة</span> بما ينتج عنه <span class="output">إطار تنظيمي واضح وقرارات تنفيذية</span>.`;
      return [s1,s2,s3];
    }

    /* ========= تحليل مهمة واحدة ========= */
    function analyzeSingleTask(text,index){
      const {verb,domain,toolPhrase,outPhrase} = extractPieces(text);

      const okVerb   = !!verb;
      const okDom    = (domain||"").split(/\s+/).filter(Boolean).length >= 2;
      const okTool   = hasTool(toolPhrase || text);
      const okOut    = hasOut(outPhrase || text);

      const missing=[];
      if(!okVerb) missing.push("فعل تنظيمي");
      if(!okDom)  missing.push("مجال واضح");
      if(!okTool) missing.push("أداة تنظيمية");
      if(!okOut)  missing.push("مخرج للمهمة");

      const isValid = missing.length===0;
      const suggestions = buildSuggestions({verb,domain});

      return `
        <div style="border:1px solid #ccc; padding:15px; margin-top:15px">
          <strong>المهمة ${index+1}</strong><br><br>

          ${isValid
            ? `<span class="ok">✔ الصياغة صحيحة ومنضبطة (${escapeHTML(verb)} + مجال + أداة + مخرج)</span>`
            : `<span class="bad">✖ الصياغة غير مكتملة</span>`}

          <br><br>

          ${!isValid ? `
            <b>العناصر الناقصة:</b>
            <ul>${missing.map(m=>`<li>${m}</li>`).join("")}</ul>

            <b>مقترحات صياغة منضبطة:</b><br><br>
            ${suggestions.map((s,i)=>`
              <div style="background:#f5f5f5;padding:10px;margin-bottom:8px" data-suggestion-block>
                <div data-s-text>${s}</div>
                <br>
                <button onclick="applySuggestion(${index},${i})">اعتماد هذه الصياغة</button>
              </div>
            `).join("")}
          ` : `
            <div style="background:#eef;padding:10px">
              <span class="verb">${escapeHTML(verb||"—")}</span> /
              <span class="domain">${okDom?"المجال واضح":"—"}</span> /
              <span class="tool">${okTool?"أداة تنظيمية":"—"}</span> /
              <span class="output">${okOut?"مخرج محدد":"—"}</span>
            </div>
          `}
        </div>
      `;
    }

    /* ========= الواجهة ========= */
    function analyzeTask(){
      const input = document.getElementById("taskInput").value.trim();
      const out = document.getElementById("output");
      if(!input){ out.innerHTML = '<span class="bad">يرجى إدخال مهمة واحدة على الأقل</span>'; return; }
      const lines = input.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      out.innerHTML = lines.map((t,i)=>analyzeSingleTask(t,i)).join("");
    }

    function applySuggestion(taskIndex,suggestionIndex){
      const inputEl = document.getElementById('taskInput');
      const blocks  = document.querySelectorAll('[data-suggestion-block]');
      const block   = blocks[taskIndex*3 + suggestionIndex]; // 3 اقتراحات لكل مهمة
      if(!block){ alert('تعذّر العثور على الصياغة.'); return; }
      const html  = block.querySelector('[data-s-text]')?.innerHTML || '';
      const plain = html.replace(/<[^>]+>/g,'').replace(/\s*\.\s*$/,'');
      const lines = inputEl.value.split(/\r?\n/).map(s=>s.trim());
      lines[taskIndex] = plain;
      inputEl.value = lines.join('\n');
      analyzeTask();
    }

    function clearAll(){
      document.getElementById('taskInput').value='';
      document.getElementById('output').innerHTML='';
    }

    async function copyOut(){
      const txt = document.getElementById('output').innerText || '';
      try{ await navigator.clipboard.writeText(txt); alert('تم النسخ'); }
      catch{ alert('تعذّر النسخ'); }
    }

    // لجعل الدوال متاحة عالميًا (لأزرار onclick)
    window.analyzeTask = analyzeTask;
    window.applySuggestion = applySuggestion;
    window.clearAll = clearAll;
    window.copyOut = copyOut;
  </script>
</body>
</html>
``
